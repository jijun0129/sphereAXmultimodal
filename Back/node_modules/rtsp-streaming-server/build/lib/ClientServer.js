"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.ClientServer = void 0;

var _basicAuth = require("basic-auth");

var _rtspServer = require("rtsp-server");

var _ClientWrapper = require("./ClientWrapper");

var _utils = require("./utils");

const debug = (0, _utils.getDebugger)('ClientServer');

/**
 *
 */
class ClientServer {
  /**
   *
   * @param rtspPort
   * @param mounts
   */
  constructor(rtspPort, mounts, hooks) {
    this.rtspPort = rtspPort;
    this.mounts = mounts;
    this.clients = {};
    this.hooks = { ...hooks
    };
    this.server = (0, _rtspServer.createServer)((req, res) => {
      debug('%s:%s request: %s', req.socket.remoteAddress, req.socket.remotePort, req.method);

      switch (req.method) {
        case 'DESCRIBE':
          return this.describeRequest(req, res);

        case 'OPTIONS':
          return this.optionsRequest(req, res);

        case 'SETUP':
          return this.setupRequest(req, res);

        case 'PLAY':
          return this.playRequest(req, res);

        case 'TEARDOWN':
          return this.teardownRequest(req, res);

        default:
          console.error('Unknown ClientServer request', {
            method: req.method,
            url: req.url
          });
          res.statusCode = 501; // Not implemented

          return res.end();
      }
    });
  }

  async start() {
    return new Promise((resolve, reject) => {
      this.server.listen(this.rtspPort, () => {
        debug('Now listening on %s', this.rtspPort);
        return resolve();
      });
    });
  }
  /**
   *
   * @param req
   * @param res
   */


  async optionsRequest(req, res) {
    // Update the client timeout if they provide a session
    if (req.headers.session && (await this.checkAuthenticated(req, res))) {
      const client = this.clients[req.headers.session];

      if (client) {
        client.keepalive();
      } else {
        res.statusCode = 454; // Session not found

        return res.end();
      }
    }

    res.setHeader('OPTIONS', 'DESCRIBE SETUP PLAY STOP');
    return res.end();
  }
  /**
   *
   * @param req
   * @param res
   */


  async describeRequest(req, res) {
    if (!(await this.checkAuthenticated(req, res))) {
      return res.end();
    } // Hook to set up the mount with a server if required before the client hits it
    // It'll fall through to a 404 regardless


    if (this.hooks.checkMount) {
      const allowed = await this.hooks.checkMount(req);

      if (!allowed || typeof allowed === 'number') {
        debug('%s:%s path not allowed by hook - hook returned: %s', req.socket.remoteAddress, req.socket.remotePort, req.uri, allowed);

        if (typeof allowed === 'number') {
          res.statusCode = allowed;
        } else {
          res.statusCode = 403;
        }

        return res.end();
      }
    }

    const mount = this.mounts.getMount(req.uri);

    if (!mount) {
      debug('%s:%s - Mount not found, sending 404: %o', req.socket.remoteAddress, req.socket.remotePort, req.uri);
      res.statusCode = 404;
      return res.end();
    }

    res.setHeader('Content-Type', 'application/sdp');
    res.setHeader('Content-Length', Buffer.byteLength(mount.sdp));
    res.write(mount.sdp);
    res.end();
  }
  /**
   *
   * @param req
   * @param res
   */


  async setupRequest(req, res) {
    if (!(await this.checkAuthenticated(req, res))) {
      return res.end();
    } // TCP not supported (yet ;-))


    if (req.headers.transport && req.headers.transport.toLowerCase().indexOf('tcp') > -1) {
      debug('%s:%s - we dont support tcp, sending 504: %o', req.socket.remoteAddress, req.socket.remotePort, req.uri);
      res.statusCode = 504;
      return res.end();
    }

    let clientWrapper;

    if (!req.headers.session) {
      clientWrapper = new _ClientWrapper.ClientWrapper(this, req);
      this.clients[clientWrapper.id] = clientWrapper;
    } else if (this.clients[req.headers.session]) {
      clientWrapper = this.clients[req.headers.session];
    } else {
      return; // This theoretically never reaches, its just to fix TS checks
    }

    res.setHeader('Session', `${clientWrapper.id};timeout=30`);
    const client = clientWrapper.addClient(req);

    try {
      await client.setup(req);
    } catch (e) {
      console.error('Error setting up client', e);
      res.statusCode = 500;
      return res.end();
    }

    res.setHeader('Transport', `${req.headers.transport};server_port=${client.rtpServerPort}-${client.rtcpServerPort}`);
    res.end();
  }
  /**
   *
   * @param req
   * @param res
   */


  async playRequest(req, res) {
    if (!(await this.checkAuthenticated(req, res))) {
      return res.end();
    }

    if (!req.headers.session || !this.clients[req.headers.session]) {
      debug('%s:%s - session not valid (%s), sending 454: %o', req.socket.remoteAddress, req.socket.remotePort, req.headers.session, req.uri);
      res.statusCode = 454; // Session not valid

      return res.end();
    }

    debug('%s calling play', req.headers.session);
    const client = this.clients[req.headers.session];
    client.play();

    if (client.mount.range) {
      res.setHeader('Range', client.mount.range);
    }

    res.end();
  }
  /**
   *
   * @param req
   * @param res
   */


  async teardownRequest(req, res) {
    if (!(await this.checkAuthenticated(req, res))) {
      return res.end();
    }

    if (!req.headers.session || !this.clients[req.headers.session]) {
      debug('%s:%s - session not valid (%s), sending 454: %o', req.socket.remoteAddress, req.socket.remotePort, req.headers.session, req.uri);
      res.statusCode = 454;
      return res.end();
    }

    debug('%s:%s tearing down client', req.socket.remoteAddress, req.socket.remotePort);
    const client = this.clients[req.headers.session];
    client.close();
    res.end();
  }
  /**
   *
   * @param clientId
   */


  async clientGone(clientId) {
    if (this.hooks.clientClose) {
      await this.hooks.clientClose(this.clients[clientId].mount);
    }

    debug('ClientWrapper %s gone', clientId);
    delete this.clients[clientId];
  }
  /**
   *
   * @param req
   * @param res
   */


  async checkAuthenticated(req, res) {
    // Ask for authentication
    if (this.hooks.authentication) {
      if (!req.headers.authorization) {
        debug('%s:%s - No authentication information (required), sending 401', req.socket.remoteAddress, req.socket.remotePort);
        res.setHeader('WWW-Authenticate', 'Basic realm="rtsp"');
        res.statusCode = 401;
        return false;
      } else {
        if (req.headers.session && this.clients[req.headers.session] && this.clients[req.headers.session].authorizationHeader !== req.headers.authorization) {
          debug('%s:%s - session header doesn\'t match the cached value, sending 401', req.socket.remoteAddress, req.socket.remotePort);
          res.setHeader('WWW-Authenticate', 'Basic realm="rtsp"');
          res.statusCode = 401;
          return false;
        }

        const result = (0, _basicAuth.parse)(req.headers.authorization);

        if (!result) {
          debug('%s:%s - No authentication information (required), sending 401', req.socket.remoteAddress, req.socket.remotePort);
          res.setHeader('WWW-Authenticate', 'Basic realm="rtsp"');
          res.statusCode = 401;
          return false;
        }

        const allowed = await this.hooks.authentication(result.name, result.pass, req, res);

        if (!allowed) {
          debug('%s:%s - No authentication information (hook returned false), sending 401', req.socket.remoteAddress, req.socket.remotePort);
          res.setHeader('WWW-Authenticate', 'Basic realm="rtsp"');
          res.statusCode = 401;
          return false;
        }
      }
    }

    return true;
  }

}

exports.ClientServer = ClientServer;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9saWIvQ2xpZW50U2VydmVyLnRzIl0sIm5hbWVzIjpbImRlYnVnIiwiQ2xpZW50U2VydmVyIiwiY29uc3RydWN0b3IiLCJydHNwUG9ydCIsIm1vdW50cyIsImhvb2tzIiwiY2xpZW50cyIsInNlcnZlciIsInJlcSIsInJlcyIsInNvY2tldCIsInJlbW90ZUFkZHJlc3MiLCJyZW1vdGVQb3J0IiwibWV0aG9kIiwiZGVzY3JpYmVSZXF1ZXN0Iiwib3B0aW9uc1JlcXVlc3QiLCJzZXR1cFJlcXVlc3QiLCJwbGF5UmVxdWVzdCIsInRlYXJkb3duUmVxdWVzdCIsImNvbnNvbGUiLCJlcnJvciIsInVybCIsInN0YXR1c0NvZGUiLCJlbmQiLCJzdGFydCIsIlByb21pc2UiLCJyZXNvbHZlIiwicmVqZWN0IiwibGlzdGVuIiwiaGVhZGVycyIsInNlc3Npb24iLCJjaGVja0F1dGhlbnRpY2F0ZWQiLCJjbGllbnQiLCJrZWVwYWxpdmUiLCJzZXRIZWFkZXIiLCJjaGVja01vdW50IiwiYWxsb3dlZCIsInVyaSIsIm1vdW50IiwiZ2V0TW91bnQiLCJCdWZmZXIiLCJieXRlTGVuZ3RoIiwic2RwIiwid3JpdGUiLCJ0cmFuc3BvcnQiLCJ0b0xvd2VyQ2FzZSIsImluZGV4T2YiLCJjbGllbnRXcmFwcGVyIiwiQ2xpZW50V3JhcHBlciIsImlkIiwiYWRkQ2xpZW50Iiwic2V0dXAiLCJlIiwicnRwU2VydmVyUG9ydCIsInJ0Y3BTZXJ2ZXJQb3J0IiwicGxheSIsInJhbmdlIiwiY2xvc2UiLCJjbGllbnRHb25lIiwiY2xpZW50SWQiLCJjbGllbnRDbG9zZSIsImF1dGhlbnRpY2F0aW9uIiwiYXV0aG9yaXphdGlvbiIsImF1dGhvcml6YXRpb25IZWFkZXIiLCJyZXN1bHQiLCJuYW1lIiwicGFzcyJdLCJtYXBwaW5ncyI6Ijs7Ozs7OztBQUFBOztBQUNBOztBQUVBOztBQUdBOztBQUVBLE1BQU1BLEtBQUssR0FBRyx3QkFBWSxjQUFaLENBQWQ7O0FBUUE7OztBQUdP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QU0sR0FBRyxzQkFBTXhELEdBQUcsQ0FBQ3FCLE9BQUosQ0FBWWlDLGFBQWxCLENBQWY7O0FBQ0EsWUFBSSxDQUFDRSxNQUFMLEVBQWE7QUFDWGhFLFVBQUFBLEtBQUssQ0FBQywrREFBRCxFQUFrRVEsR0FBRyxDQUFDRSxNQUFKLENBQVdDLGFBQTdFLEVBQTRGSCxHQUFHLENBQUNFLE1BQUosQ0FBV0UsVUFBdkcsQ0FBTDtBQUNBSCxVQUFBQSxHQUFHLENBQUN5QixTQUFKLENBQWMsa0JBQWQsRUFBa0Msb0JBQWxDO0FBQ0F6QixVQUFBQSxHQUFHLENBQUNhLFVBQUosR0FBaUIsR0FBakI7QUFDQSxpQkFBTyxLQUFQO0FBQ0Q7O0FBRUQsY0FBTWMsT0FBTyxHQUFHLE1BQU0sS0FBSy9CLEtBQUwsQ0FBV3dELGNBQVgsQ0FBMEJHLE1BQU0sQ0FBQ0MsSUFBakMsRUFBdUNELE1BQU0sQ0FBQ0UsSUFBOUMsRUFBb0QxRCxHQUFwRCxFQUF5REMsR0FBekQsQ0FBdEI7O0FBQ0EsWUFBSSxDQUFDMkIsT0FBTCxFQUFjO0FBQ1pwQyxVQUFBQSxLQUFLLENBQUMsMEVBQUQsRUFBNkVRLEdBQUcsQ0FBQ0UsTUFBSixDQUFXQyxhQUF4RixFQUF1R0gsR0FBRyxDQUFDRSxNQUFKLENBQVdFLFVBQWxILENBQUw7QUFDQUgsVUFBQUEsR0FBRyxDQUFDeUIsU0FBSixDQUFjLGtCQUFkLEVBQWtDLG9CQUFsQztBQUNBekIsVUFBQUEsR0FBRyxDQUFDYSxVQUFKLEdBQWlCLEdBQWpCO0FBQ0EsaUJBQU8sS0FBUDtBQUNEO0FBQ0Y7QUFDRjs7QUFFRCxXQUFPLElBQVA7QUFDRDs7QUF4UXVCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgcGFyc2UgfSBmcm9tICdiYXNpYy1hdXRoJztcbmltcG9ydCB7IGNyZWF0ZVNlcnZlciwgUnRzcFJlcXVlc3QsIFJ0c3BSZXNwb25zZSwgUnRzcFNlcnZlciB9IGZyb20gJ3J0c3Atc2VydmVyJztcblxuaW1wb3J0IHsgQ2xpZW50V3JhcHBlciB9IGZyb20gJy4vQ2xpZW50V3JhcHBlcic7XG5pbXBvcnQgeyBNb3VudCB9IGZyb20gJy4vTW91bnQnO1xuaW1wb3J0IHsgTW91bnRzIH0gZnJvbSAnLi9Nb3VudHMnO1xuaW1wb3J0IHsgZ2V0RGVidWdnZXIgfSBmcm9tICcuL3V0aWxzJztcblxuY29uc3QgZGVidWcgPSBnZXREZWJ1Z2dlcignQ2xpZW50U2VydmVyJyk7XG5cbmV4cG9ydCBpbnRlcmZhY2UgQ2xpZW50U2VydmVySG9va3NDb25maWcge1xuICBhdXRoZW50aWNhdGlvbj86ICh1c2VybmFtZTogc3RyaW5nLCBwYXNzd29yZDogc3RyaW5nLCByZXE6IFJ0c3BSZXF1ZXN0LCByZXM6IFJ0c3BSZXNwb25zZSkgPT4gUHJvbWlzZTxib29sZWFuPjtcbiAgY2hlY2tNb3VudD86IChyZXE6IFJ0c3BSZXF1ZXN0KSA9PiBQcm9taXNlPGJvb2xlYW4gfCBudW1iZXI+O1xuICBjbGllbnRDbG9zZT86IChtb3VudDogTW91bnQpID0+IFByb21pc2U8dm9pZD47XG59XG5cbi8qKlxuICpcbiAqL1xuZXhwb3J0IGNsYXNzIENsaWVudFNlcnZlciB7XG4gIGhvb2tzOiBDbGllbnRTZXJ2ZXJIb29rc0NvbmZpZztcblxuICBtb3VudHM6IE1vdW50cztcbiAgcnRzcFBvcnQ6IG51bWJlcjtcbiAgc2VydmVyOiBSdHNwU2VydmVyO1xuICBjbGllbnRzOiB7IFtzZXNzaW9uSWQ6IHN0cmluZ106IENsaWVudFdyYXBwZXIgfTtcblxuICAvKipcbiAgICpcbiAgICogQHBhcmFtIHJ0c3BQb3J0XG4gICAqIEBwYXJhbSBtb3VudHNcbiAgICovXG4gIGNvbnN0cnVjdG9yIChydHNwUG9ydDogbnVtYmVyLCBtb3VudHM6IE1vdW50cywgaG9va3M/OiBDbGllbnRTZXJ2ZXJIb29rc0NvbmZpZykge1xuICAgIHRoaXMucnRzcFBvcnQgPSBydHNwUG9ydDtcbiAgICB0aGlzLm1vdW50cyA9IG1vdW50cztcblxuICAgIHRoaXMuY2xpZW50cyA9IHt9O1xuXG4gICAgdGhpcy5ob29rcyA9IHtcbiAgICAgIC4uLmhvb2tzXG4gICAgfTtcblxuICAgIHRoaXMuc2VydmVyID0gY3JlYXRlU2VydmVyKChyZXE6IFJ0c3BSZXF1ZXN0LCByZXM6IFJ0c3BSZXNwb25zZSkgPT4ge1xuICAgICAgZGVidWcoJyVzOiVzIHJlcXVlc3Q6ICVzJywgcmVxLnNvY2tldC5yZW1vdGVBZGRyZXNzLCByZXEuc29ja2V0LnJlbW90ZVBvcnQsIHJlcS5tZXRob2QpO1xuICAgICAgc3dpdGNoIChyZXEubWV0aG9kKSB7XG4gICAgICAgIGNhc2UgJ0RFU0NSSUJFJzpcbiAgICAgICAgICByZXR1cm4gdGhpcy5kZXNjcmliZVJlcXVlc3QocmVxLCByZXMpO1xuICAgICAgICBjYXNlICdPUFRJT05TJzpcbiAgICAgICAgICByZXR1cm4gdGhpcy5vcHRpb25zUmVxdWVzdChyZXEsIHJlcyk7XG4gICAgICAgIGNhc2UgJ1NFVFVQJzpcbiAgICAgICAgICByZXR1cm4gdGhpcy5zZXR1cFJlcXVlc3QocmVxLCByZXMpO1xuICAgICAgICBjYXNlICdQTEFZJzpcbiAgICAgICAgICByZXR1cm4gdGhpcy5wbGF5UmVxdWVzdChyZXEsIHJlcyk7XG4gICAgICAgIGNhc2UgJ1RFQVJET1dOJzpcbiAgICAgICAgICByZXR1cm4gdGhpcy50ZWFyZG93blJlcXVlc3QocmVxLCByZXMpO1xuICAgICAgICBkZWZhdWx0OlxuICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ1Vua25vd24gQ2xpZW50U2VydmVyIHJlcXVlc3QnLCB7IG1ldGhvZDogcmVxLm1ldGhvZCwgdXJsOiByZXEudXJsIH0pO1xuICAgICAgICAgIHJlcy5zdGF0dXNDb2RlID0gNTAxOyAvLyBOb3QgaW1wbGVtZW50ZWRcbiAgICAgICAgICByZXR1cm4gcmVzLmVuZCgpO1xuICAgICAgfVxuICAgIH0pO1xuICB9XG5cbiAgYXN5bmMgc3RhcnQgKCk6IFByb21pc2U8dm9pZD4ge1xuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICB0aGlzLnNlcnZlci5saXN0ZW4odGhpcy5ydHNwUG9ydCwgKCkgPT4ge1xuICAgICAgICBkZWJ1ZygnTm93IGxpc3RlbmluZyBvbiAlcycsIHRoaXMucnRzcFBvcnQpO1xuXG4gICAgICAgIHJldHVybiByZXNvbHZlKCk7XG4gICAgICB9KTtcbiAgICB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKlxuICAgKiBAcGFyYW0gcmVxXG4gICAqIEBwYXJhbSByZXNcbiAgICovXG4gIGFzeW5jIG9wdGlvbnNSZXF1ZXN0IChyZXE6IFJ0c3BSZXF1ZXN0LCByZXM6IFJ0c3BSZXNwb25zZSk6IFByb21pc2U8dm9pZD4ge1xuICAgIC8vIFVwZGF0ZSB0aGUgY2xpZW50IHRpbWVvdXQgaWYgdGhleSBwcm92aWRlIGEgc2Vzc2lvblxuICAgIGlmIChyZXEuaGVhZGVycy5zZXNzaW9uICYmIGF3YWl0IHRoaXMuY2hlY2tBdXRoZW50aWNhdGVkKHJlcSwgcmVzKSkge1xuICAgICAgY29uc3QgY2xpZW50ID0gdGhpcy5jbGllbnRzW3JlcS5oZWFkZXJzLnNlc3Npb25dO1xuICAgICAgaWYgKGNsaWVudCkge1xuICAgICAgICBjbGllbnQua2VlcGFsaXZlKCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZXMuc3RhdHVzQ29kZSA9IDQ1NDsgLy8gU2Vzc2lvbiBub3QgZm91bmRcbiAgICAgICAgcmV0dXJuIHJlcy5lbmQoKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICByZXMuc2V0SGVhZGVyKCdPUFRJT05TJywgJ0RFU0NSSUJFIFNFVFVQIFBMQVkgU1RPUCcpO1xuICAgIHJldHVybiByZXMuZW5kKCk7XG4gIH1cblxuICAvKipcbiAgICpcbiAgICogQHBhcmFtIHJlcVxuICAgKiBAcGFyYW0gcmVzXG4gICAqL1xuICBhc3luYyBkZXNjcmliZVJlcXVlc3QgKHJlcTogUnRzcFJlcXVlc3QsIHJlczogUnRzcFJlc3BvbnNlKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgaWYgKCFhd2FpdCB0aGlzLmNoZWNrQXV0aGVudGljYXRlZChyZXEsIHJlcykpIHtcbiAgICAgIHJldHVybiByZXMuZW5kKCk7XG4gICAgfVxuXG4gICAgLy8gSG9vayB0byBzZXQgdXAgdGhlIG1vdW50IHdpdGggYSBzZXJ2ZXIgaWYgcmVxdWlyZWQgYmVmb3JlIHRoZSBjbGllbnQgaGl0cyBpdFxuICAgIC8vIEl0J2xsIGZhbGwgdGhyb3VnaCB0byBhIDQwNCByZWdhcmRsZXNzXG4gICAgaWYgKHRoaXMuaG9va3MuY2hlY2tNb3VudCkge1xuICAgICAgY29uc3QgYWxsb3dlZCA9IGF3YWl0IHRoaXMuaG9va3MuY2hlY2tNb3VudChyZXEpO1xuICAgICAgaWYgKCFhbGxvd2VkIHx8IHR5cGVvZiBhbGxvd2VkID09PSAnbnVtYmVyJykge1xuICAgICAgICBkZWJ1ZygnJXM6JXMgcGF0aCBub3QgYWxsb3dlZCBieSBob29rIC0gaG9vayByZXR1cm5lZDogJXMnLCByZXEuc29ja2V0LnJlbW90ZUFkZHJlc3MsIHJlcS5zb2NrZXQucmVtb3RlUG9ydCwgcmVxLnVyaSwgYWxsb3dlZCk7XG4gICAgICAgIGlmICh0eXBlb2YgYWxsb3dlZCA9PT0gJ251bWJlcicpIHtcbiAgICAgICAgICByZXMuc3RhdHVzQ29kZSA9IGFsbG93ZWQ7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgcmVzLnN0YXR1c0NvZGUgPSA0MDM7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gcmVzLmVuZCgpO1xuICAgICAgfVxuICAgIH1cblxuICAgIGNvbnN0IG1vdW50ID0gdGhpcy5tb3VudHMuZ2V0TW91bnQocmVxLnVyaSk7XG5cbiAgICBpZiAoIW1vdW50KSB7XG4gICAgICBkZWJ1ZygnJXM6JXMgLSBNb3VudCBub3QgZm91bmQsIHNlbmRpbmcgNDA0OiAlbycsIHJlcS5zb2NrZXQucmVtb3RlQWRkcmVzcywgcmVxLnNvY2tldC5yZW1vdGVQb3J0LCByZXEudXJpKTtcbiAgICAgIHJlcy5zdGF0dXNDb2RlID0gNDA0O1xuICAgICAgcmV0dXJuIHJlcy5lbmQoKTtcbiAgICB9XG5cbiAgICByZXMuc2V0SGVhZGVyKCdDb250ZW50LVR5cGUnLCAnYXBwbGljYXRpb24vc2RwJyk7XG4gICAgcmVzLnNldEhlYWRlcignQ29udGVudC1MZW5ndGgnLCBCdWZmZXIuYnl0ZUxlbmd0aChtb3VudC5zZHApKTtcblxuICAgIHJlcy53cml0ZShtb3VudC5zZHApO1xuICAgIHJlcy5lbmQoKTtcbiAgfVxuXG4gIC8qKlxuICAgKlxuICAgKiBAcGFyYW0gcmVxXG4gICAqIEBwYXJhbSByZXNcbiAgICovXG4gIGFzeW5jIHNldHVwUmVxdWVzdCAocmVxOiBSdHNwUmVxdWVzdCwgcmVzOiBSdHNwUmVzcG9uc2UpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBpZiAoIWF3YWl0IHRoaXMuY2hlY2tBdXRoZW50aWNhdGVkKHJlcSwgcmVzKSkge1xuICAgICAgcmV0dXJuIHJlcy5lbmQoKTtcbiAgICB9XG5cbiAgICAvLyBUQ1Agbm90IHN1cHBvcnRlZCAoeWV0IDstKSlcbiAgICBpZiAocmVxLmhlYWRlcnMudHJhbnNwb3J0ICYmIHJlcS5oZWFkZXJzLnRyYW5zcG9ydC50b0xvd2VyQ2FzZSgpLmluZGV4T2YoJ3RjcCcpID4gLTEpIHtcbiAgICAgIGRlYnVnKCclczolcyAtIHdlIGRvbnQgc3VwcG9ydCB0Y3AsIHNlbmRpbmcgNTA0OiAlbycsIHJlcS5zb2NrZXQucmVtb3RlQWRkcmVzcywgcmVxLnNvY2tldC5yZW1vdGVQb3J0LCByZXEudXJpKTtcbiAgICAgIHJlcy5zdGF0dXNDb2RlID0gNTA0O1xuICAgICAgcmV0dXJuIHJlcy5lbmQoKTtcbiAgICB9XG5cbiAgICBsZXQgY2xpZW50V3JhcHBlcjogQ2xpZW50V3JhcHBlcjtcblxuICAgIGlmICghcmVxLmhlYWRlcnMuc2Vzc2lvbikge1xuICAgICAgY2xpZW50V3JhcHBlciA9IG5ldyBDbGllbnRXcmFwcGVyKHRoaXMsIHJlcSk7XG4gICAgICB0aGlzLmNsaWVudHNbY2xpZW50V3JhcHBlci5pZF0gPSBjbGllbnRXcmFwcGVyO1xuICAgIH0gZWxzZSBpZiAodGhpcy5jbGllbnRzW3JlcS5oZWFkZXJzLnNlc3Npb25dKSB7XG4gICAgICBjbGllbnRXcmFwcGVyID0gdGhpcy5jbGllbnRzW3JlcS5oZWFkZXJzLnNlc3Npb25dO1xuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm47IC8vIFRoaXMgdGhlb3JldGljYWxseSBuZXZlciByZWFjaGVzLCBpdHMganVzdCB0byBmaXggVFMgY2hlY2tzXG4gICAgfVxuXG4gICAgcmVzLnNldEhlYWRlcignU2Vzc2lvbicsIGAke2NsaWVudFdyYXBwZXIuaWR9O3RpbWVvdXQ9MzBgKTtcbiAgICBjb25zdCBjbGllbnQgPSBjbGllbnRXcmFwcGVyLmFkZENsaWVudChyZXEpO1xuXG4gICAgdHJ5IHtcbiAgICAgIGF3YWl0IGNsaWVudC5zZXR1cChyZXEpO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoJ0Vycm9yIHNldHRpbmcgdXAgY2xpZW50JywgZSk7XG4gICAgICByZXMuc3RhdHVzQ29kZSA9IDUwMDtcbiAgICAgIHJldHVybiByZXMuZW5kKCk7XG4gICAgfVxuXG4gICAgcmVzLnNldEhlYWRlcignVHJhbnNwb3J0JywgYCR7cmVxLmhlYWRlcnMudHJhbnNwb3J0fTtzZXJ2ZXJfcG9ydD0ke2NsaWVudC5ydHBTZXJ2ZXJQb3J0fS0ke2NsaWVudC5ydGNwU2VydmVyUG9ydH1gKTtcblxuICAgIHJlcy5lbmQoKTtcbiAgfVxuXG4gIC8qKlxuICAgKlxuICAgKiBAcGFyYW0gcmVxXG4gICAqIEBwYXJhbSByZXNcbiAgICovXG4gIGFzeW5jIHBsYXlSZXF1ZXN0IChyZXE6IFJ0c3BSZXF1ZXN0LCByZXM6IFJ0c3BSZXNwb25zZSk6IFByb21pc2U8dm9pZD4ge1xuICAgIGlmICghYXdhaXQgdGhpcy5jaGVja0F1dGhlbnRpY2F0ZWQocmVxLCByZXMpKSB7XG4gICAgICByZXR1cm4gcmVzLmVuZCgpO1xuICAgIH1cblxuICAgIGlmICghcmVxLmhlYWRlcnMuc2Vzc2lvbiB8fCAhdGhpcy5jbGllbnRzW3JlcS5oZWFkZXJzLnNlc3Npb25dKSB7XG4gICAgICBkZWJ1ZygnJXM6JXMgLSBzZXNzaW9uIG5vdCB2YWxpZCAoJXMpLCBzZW5kaW5nIDQ1NDogJW8nLCByZXEuc29ja2V0LnJlbW90ZUFkZHJlc3MsIHJlcS5zb2NrZXQucmVtb3RlUG9ydCwgcmVxLmhlYWRlcnMuc2Vzc2lvbiwgcmVxLnVyaSk7XG4gICAgICByZXMuc3RhdHVzQ29kZSA9IDQ1NDsgLy8gU2Vzc2lvbiBub3QgdmFsaWRcbiAgICAgIHJldHVybiByZXMuZW5kKCk7XG4gICAgfVxuXG4gICAgZGVidWcoJyVzIGNhbGxpbmcgcGxheScsIHJlcS5oZWFkZXJzLnNlc3Npb24pO1xuICAgIGNvbnN0IGNsaWVudCA9IHRoaXMuY2xpZW50c1tyZXEuaGVhZGVycy5zZXNzaW9uXTtcbiAgICBjbGllbnQucGxheSgpO1xuXG4gICAgaWYgKGNsaWVudC5tb3VudC5yYW5nZSkge1xuICAgICAgcmVzLnNldEhlYWRlcignUmFuZ2UnLCBjbGllbnQubW91bnQucmFuZ2UpO1xuICAgIH1cblxuICAgIHJlcy5lbmQoKTtcbiAgfVxuXG4gIC8qKlxuICAgKlxuICAgKiBAcGFyYW0gcmVxXG4gICAqIEBwYXJhbSByZXNcbiAgICovXG4gIGFzeW5jIHRlYXJkb3duUmVxdWVzdCAocmVxOiBSdHNwUmVxdWVzdCwgcmVzOiBSdHNwUmVzcG9uc2UpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBpZiAoIWF3YWl0IHRoaXMuY2hlY2tBdXRoZW50aWNhdGVkKHJlcSwgcmVzKSkge1xuICAgICAgcmV0dXJuIHJlcy5lbmQoKTtcbiAgICB9XG5cbiAgICBpZiAoIXJlcS5oZWFkZXJzLnNlc3Npb24gfHwgIXRoaXMuY2xpZW50c1tyZXEuaGVhZGVycy5zZXNzaW9uXSkge1xuICAgICAgZGVidWcoJyVzOiVzIC0gc2Vzc2lvbiBub3QgdmFsaWQgKCVzKSwgc2VuZGluZyA0NTQ6ICVvJywgcmVxLnNvY2tldC5yZW1vdGVBZGRyZXNzLCByZXEuc29ja2V0LnJlbW90ZVBvcnQsIHJlcS5oZWFkZXJzLnNlc3Npb24sIHJlcS51cmkpO1xuICAgICAgcmVzLnN0YXR1c0NvZGUgPSA0NTQ7XG4gICAgICByZXR1cm4gcmVzLmVuZCgpO1xuICAgIH1cblxuICAgIGRlYnVnKCclczolcyB0ZWFyaW5nIGRvd24gY2xpZW50JywgcmVxLnNvY2tldC5yZW1vdGVBZGRyZXNzLCByZXEuc29ja2V0LnJlbW90ZVBvcnQpO1xuICAgIGNvbnN0IGNsaWVudCA9IHRoaXMuY2xpZW50c1tyZXEuaGVhZGVycy5zZXNzaW9uXTtcbiAgICBjbGllbnQuY2xvc2UoKTtcblxuICAgIHJlcy5lbmQoKTtcbiAgfVxuXG4gIC8qKlxuICAgKlxuICAgKiBAcGFyYW0gY2xpZW50SWRcbiAgICovXG4gIGFzeW5jIGNsaWVudEdvbmUgKGNsaWVudElkOiBzdHJpbmcpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBpZiAodGhpcy5ob29rcy5jbGllbnRDbG9zZSkge1xuICAgICAgYXdhaXQgdGhpcy5ob29rcy5jbGllbnRDbG9zZSh0aGlzLmNsaWVudHNbY2xpZW50SWRdLm1vdW50KTtcbiAgICB9XG5cbiAgICBkZWJ1ZygnQ2xpZW50V3JhcHBlciAlcyBnb25lJywgY2xpZW50SWQpO1xuXG4gICAgZGVsZXRlIHRoaXMuY2xpZW50c1tjbGllbnRJZF07XG4gIH1cblxuICAvKipcbiAgICpcbiAgICogQHBhcmFtIHJlcVxuICAgKiBAcGFyYW0gcmVzXG4gICAqL1xuICBwcml2YXRlIGFzeW5jIGNoZWNrQXV0aGVudGljYXRlZCAocmVxOiBSdHNwUmVxdWVzdCwgcmVzOiBSdHNwUmVzcG9uc2UpOiBQcm9taXNlPGJvb2xlYW4+IHtcbiAgICAvLyBBc2sgZm9yIGF1dGhlbnRpY2F0aW9uXG4gICAgaWYgKHRoaXMuaG9va3MuYXV0aGVudGljYXRpb24pIHtcbiAgICAgIGlmICghcmVxLmhlYWRlcnMuYXV0aG9yaXphdGlvbikge1xuICAgICAgICBkZWJ1ZygnJXM6JXMgLSBObyBhdXRoZW50aWNhdGlvbiBpbmZvcm1hdGlvbiAocmVxdWlyZWQpLCBzZW5kaW5nIDQwMScsIHJlcS5zb2NrZXQucmVtb3RlQWRkcmVzcywgcmVxLnNvY2tldC5yZW1vdGVQb3J0KTtcbiAgICAgICAgcmVzLnNldEhlYWRlcignV1dXLUF1dGhlbnRpY2F0ZScsICdCYXNpYyByZWFsbT1cInJ0c3BcIicpO1xuICAgICAgICByZXMuc3RhdHVzQ29kZSA9IDQwMTtcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgaWYgKHJlcS5oZWFkZXJzLnNlc3Npb24gJiYgdGhpcy5jbGllbnRzW3JlcS5oZWFkZXJzLnNlc3Npb25dICYmIHRoaXMuY2xpZW50c1tyZXEuaGVhZGVycy5zZXNzaW9uXS5hdXRob3JpemF0aW9uSGVhZGVyICE9PSByZXEuaGVhZGVycy5hdXRob3JpemF0aW9uKSB7XG4gICAgICAgICAgZGVidWcoJyVzOiVzIC0gc2Vzc2lvbiBoZWFkZXIgZG9lc25cXCd0IG1hdGNoIHRoZSBjYWNoZWQgdmFsdWUsIHNlbmRpbmcgNDAxJywgcmVxLnNvY2tldC5yZW1vdGVBZGRyZXNzLCByZXEuc29ja2V0LnJlbW90ZVBvcnQpO1xuICAgICAgICAgIHJlcy5zZXRIZWFkZXIoJ1dXVy1BdXRoZW50aWNhdGUnLCAnQmFzaWMgcmVhbG09XCJydHNwXCInKTtcbiAgICAgICAgICByZXMuc3RhdHVzQ29kZSA9IDQwMTtcbiAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCByZXN1bHQgPSBwYXJzZShyZXEuaGVhZGVycy5hdXRob3JpemF0aW9uKTtcbiAgICAgICAgaWYgKCFyZXN1bHQpIHtcbiAgICAgICAgICBkZWJ1ZygnJXM6JXMgLSBObyBhdXRoZW50aWNhdGlvbiBpbmZvcm1hdGlvbiAocmVxdWlyZWQpLCBzZW5kaW5nIDQwMScsIHJlcS5zb2NrZXQucmVtb3RlQWRkcmVzcywgcmVxLnNvY2tldC5yZW1vdGVQb3J0KTtcbiAgICAgICAgICByZXMuc2V0SGVhZGVyKCdXV1ctQXV0aGVudGljYXRlJywgJ0Jhc2ljIHJlYWxtPVwicnRzcFwiJyk7XG4gICAgICAgICAgcmVzLnN0YXR1c0NvZGUgPSA0MDE7XG4gICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgYWxsb3dlZCA9IGF3YWl0IHRoaXMuaG9va3MuYXV0aGVudGljYXRpb24ocmVzdWx0Lm5hbWUsIHJlc3VsdC5wYXNzLCByZXEsIHJlcyk7XG4gICAgICAgIGlmICghYWxsb3dlZCkge1xuICAgICAgICAgIGRlYnVnKCclczolcyAtIE5vIGF1dGhlbnRpY2F0aW9uIGluZm9ybWF0aW9uIChob29rIHJldHVybmVkIGZhbHNlKSwgc2VuZGluZyA0MDEnLCByZXEuc29ja2V0LnJlbW90ZUFkZHJlc3MsIHJlcS5zb2NrZXQucmVtb3RlUG9ydCk7XG4gICAgICAgICAgcmVzLnNldEhlYWRlcignV1dXLUF1dGhlbnRpY2F0ZScsICdCYXNpYyByZWFsbT1cInJ0c3BcIicpO1xuICAgICAgICAgIHJlcy5zdGF0dXNDb2RlID0gNDAxO1xuICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiB0cnVlO1xuICB9XG59XG4iXX0=